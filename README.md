# Moonlit Mafia

Lightweight social deduction for the browser: several civilians and one detective try to survive while one or two werewolves eliminate the town. The experience is split between a FastAPI backend and a Vite + React frontend, with support for audio uploads, automatic transcripts, and optional AI-controlled players.


# Project Overview

In our project, we worked with the RAVDESS emotional speech dataset, which includes 15 different emotions and multiple speakers. We used this dataset to voice-clone different characters with diverse emotional expressions.

To fully demonstrate the strengths of the Higgs Audio V2 generation model — especially in multi-speaker and emotional dialogue — we designed an AI-driven Werewolf/Mafia game.


# Pipeline & System Design

Here’s how the pipeline works:
    •    We use Qwen-Thinking to generate the in-game dialogue, including both the content and emotional instructions for each speaker. This emotion-rich text is then passed to Higgs V2 for high-quality audio generation.
    •    We apply Qwen Omni, Qwen-Thinking, and the Higgs Understanding model for
ASR (Automatic Speech Recognition) and AER (Audio Emotion Recognition),
enabling characters to “listen” and react to what others say.
    •    The game logic — such as how the werewolves decide their target,
and how the detective selects someone to investigate — is also powered by Qwen models,
making the entire game adaptive, interactive, and dynamic.


## Project Structure

- `backend/` – FastAPI service that manages lobbies, roles, turns, audio storage, and AI helpers.
- `frontend/` – Vite + React single-page app that consumes the API.

## Backend (FastAPI)

1. Create and activate a virtual environment (optional but recommended):
   ```bash
   python -m venv .venv
   .venv\Scripts\activate  # Windows
   source .venv/bin/activate  # macOS/Linux
   ```
2. Install dependencies:
   ```bash
   pip install -r backend/requirements.txt
   ```
3. Run the API:
   ```bash
   uvicorn backend.app.main:app --reload --host 0.0.0.0 --port 8000
   ```

Game state is kept in memory; restart the server to wipe all rooms. Audio clips are written under `backend/data/audio/<game-id>/` and include lightweight mock transcripts ready to be swapped for a real speech-to-text engine.

## Frontend (React + Vite)

1. Install dependencies:
   ```bash
   cd frontend
   npm install
   ```
2. Start the dev server:
   ```bash
   npm run dev
   ```
3. Open the printed URL (defaults to `http://localhost:5173`).

By default the SPA targets `http://localhost:8000`. Override via `frontend/.env`:

```ini
VITE_API_BASE_URL=http://your-backend-host:8000
```

Restart `npm run dev` after changing environment variables.

## Gameplay Flow

1. **Lobby** – Host creates a room and shares the join code. Optional AI residents can be added before the game starts.
2. **Deal roles** – Host clicks _Start First Night_. Everyone receives a role (civilians, a single detective, and one or two werewolves).
3. **Night phase** – The host resolves the night. Werewolves eliminate a random non-wolf and the detective collects a private clue.
4. **Day discussion** – A speaking order is generated automatically. The host advances speakers with **Next Speaker** and closes the day using **Close Day**.
5. **Repeat** – Night and day alternate until either (a) all werewolves are dead, (b) wolves reach parity with the town, or (c) the host ends the game manually to reveal roles.
6. **Reset** – Use _Back to Start_ on the frontend (or restart the backend) to spin up a fresh lobby.

## Extra Features

- **Turn-based workflow** – The UI highlights the current speaker, tracks day/night phases, and enforces that only the host can resolve each phase.
- **Detective notes** – Night investigations produce private notes only visible to the detective on their role card.
- **AI residents** – Hosts can add AI-controlled players. Each AI broadcast produces randomized text plus a generated `.wav` clip stored alongside player uploads.
- **Voice uploads with transcripts** – Any player can record a short message. Clips are persisted on disk, exposed via the API, and paired with autogenerated placeholder transcripts for the timeline.
- **Event timeline** – Night attacks, day transitions, and win conditions are collected into a running log for all players to review.
